<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="generator" content="Hugo 0.72.0-DEV" />
        <title>Server-side KaTeX With Hugo: Part 2 - graeme phillips posting</title>
        <link href="/css/katex.min.css" rel="stylesheet" type="text/css">

        <link href="/css/style.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <div class="content">
            
                <header class="page-header">
    <h1 class="page-title"><a href="/">Ï†</a></h1>
    <span class="name">graeme phillips posting</span>
    <span class="links">
    <a href="https://github.com/graemephi" class="github icon" title="Github">
        <svg  height="30px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="30px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

    </a>
    <a href="https://twitter.com/graemephi" class="twitter icon" title="Twitter">
        <svg height="30px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="30px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>
</span>

</header>

            
            
    <div class="post-header">
    <h1 class="post-title"><a href="/posts/server-side-katex-with-hugo-part-2/">Server-side KaTeX With Hugo: Part 2</a></h1>
    <span class="date">January 19, 2020</span>
</div>

<div class="post">
<p>So, despite saying I didn&rsquo;t want to do this in my <a href="/posts/static-katex-with-hugo/">last post</a> on this, <a href="https://github.com/graemephi/kahugo">I went and forked Hugo</a>. Now rendering with KaTeX is way faster, and basically free when using <code>hugo server</code>.</p>
<p>This was more driven by curiosity than a desire to make things fast. At some point a couple weeks ago I was reminded of <a href="https://bellard.org/quickjs/">QuickJS</a>, and from there it was a short series of small steps to my downfall. QuickJS really enabled this. It was easy to replace the javascript from my previous post with an executable that ran the qjs interpreter on KateX bytecode, and easy to then link it to a Haskell program that drove Pandoc as a library rather than using the command line. Having done <em>that</em>, getting Goldmark, Hugo&rsquo;s markdown processor, to render TeX using KaTeX was also a small amount of work.</p>
<p>Rather than this post just being, &ldquo;hey, I&rsquo;m doing this now instead,&rdquo; I guess I&rsquo;ll talk a bit more about it.</p>
<p>Goldmark is fairly extensible so shoe-horning in TeX-awareness just means telling Goldmark&rsquo;s parser to call our code when it hits a <code>$</code>: I put maths between <code>$</code> and <code>$$</code>, so <code>$x$</code> gets rendered as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span></span></span>. But taking responsibility for parsing any markdown yourself means you have to think about weird edge cases<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<p>Take links. Links in markdown have the following syntax: <code>[foo](bar.tld)</code>. So, how should <code>[$foo](bar.tld$)</code> be parsed? In my opinion, there is a correct answer here: that&rsquo;s a link. I&rsquo;ve found people citing some old RFC that prohibits $ in urls, but <a href="https://en.wikipedia.org/wiki/$">they&rsquo;re valid</a>. Anyone who writes <code>[$](en.wikipedia.org/wiki/$)</code> wants that to be a link, and I can&rsquo;t think of any exceptions.</p>
<p>By the way, that $ in the previous paragraph also needs to be parsed as a $, and not the opening dollar of maths.</p>
<p>So, those are links. What about <code>[$[0, 1]$](url)</code>? There&rsquo;s something satisfying about being able to link maths: <a href="https://en.wikipedia.org/wiki/Unit_interval"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></a>. So, that first example we want to not parse as TeX, and the second we do, and in order to support both we have to know if we are inside a link or not. Parsing!</p>
<p>Thankfully, we have a working TeX-aware markdown processor already: Pandoc. After fixing up some minor differences between how Goldmark and Pandoc renders the HTML, Pandoc, with the old filter from last time, can <a href="https://github.com/graemephi/goldmark-qjs-katex/blob/master/gen.go">generate a bunch of test cases</a>. I don&rsquo;t follow Pandoc&rsquo;s example in one place; Pandoc&rsquo;s rule for allowing <code>$[]$</code> inside links seems to be that the brackets must be balanced. I opted for requiring <code>[</code> to appear before <code>]</code> (which would otherwise close the link).</p>
<p>Next, some threading stuff. Hugo uses goroutines, and the QuickJS runtime can only be used single-threaded. We don&rsquo;t want to make each goroutine queue to access QuickJS, and we also want to keep our changes to Hugo to a minimum. From a C perspective, there&rsquo;s a really obvious solution: give each thread its own QuickJS runtime using thread-local storage. But goroutines aren&rsquo;t threads, and the Go scheduler wants to schedule goroutines to any thread it likes. This means that between two calls into QuickJS the goroutine can move thread, and whatever way we have of communicating with the QuickJS runtime from Go needs to be okay with this happening.</p>
<p>What I decided to do was to just never allocate anything that would be passed back to Go, and have the Go code pass in memory instead. This makes the C code pure as far as Go is concerned, so we can use thread-local and not worry about the Go scheduler. It also means we don&rsquo;t have to call free, which is always good.</p>
<p>Last time, I reported that a single page with TeX took half a second to render. Now, my entire site takes 240ms. Without KaTeX, it&rsquo;s around 150ms. I still find this a bit slower than it really ought to be, but I suppose for how little work it was, it&rsquo;s pretty good.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>The <a href="https://spec.commonmark.org/">Commonmark spec</a> is a great resource for all the markdown parsing gotchas you&rsquo;ve never thought about before. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

</div>


            
    



    <h3>More Posts</h3>
    <ol reversed>

<li style="list-style: none">
    <a href="https://graemephi.github.io/posts/stb_ds-string-interning/">stb_ds: string interning</a> (2020-08-27)
</li>

<li style="list-style: none">
    <a href="https://graemephi.github.io/posts/deep-sky-object/">i made a twitter bot: deep sky object</a> (2020-05-20)
</li>

<li style="list-style: none">
    <a href="https://graemephi.github.io/posts/calculating-lod/">Calculating LOD</a> (2019-12-31)
</li>

<li style="list-style: none">
    <a href="https://graemephi.github.io/posts/static-katex-with-hugo/">Server-side KaTeX With Hugo</a> (2019-12-15)
</li>

<li style="list-style: none">
    <a href="https://graemephi.github.io/posts/triangle-dft/">The Discrete Fourier Transform, But With Triangles</a> (2019-12-14)
</li>

<li style="list-style: none">
    <a href="https://graemephi.github.io/posts/dumb-tricks-with-phase-inversion/">Dumb Tricks With Phase Inversion</a> (2019-06-02)
</li>

</ol>





            <div class="rss-link">
                <a href="/index.xml" title="RSS">rss</a>
            </div>
        </div>
    </body>
</html>
